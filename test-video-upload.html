<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .progress { width: 100%; height: 20px; background: #f0f0f0; margin: 10px 0; }
        .progress-bar { height: 100%; background: #4CAF50; transition: width 0.3s; }
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; }
        .file-info { background: #f9f9f9; padding: 10px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Video Upload Performance Test</h1>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <p>Click here to select a video file or drag and drop</p>
        <input type="file" id="fileInput" accept="video/*" style="display: none;">
    </div>
    
    <div id="fileInfo" style="display: none;" class="file-info">
        <h3>Selected File:</h3>
        <p id="fileName"></p>
        <p id="fileSize"></p>
        <p id="fileType"></p>
        <button onclick="uploadFile()">Upload Video</button>
    </div>
    
    <div id="progressContainer" style="display: none;">
        <h3>Upload Progress:</h3>
        <div class="progress">
            <div id="progressBar" class="progress-bar" style="width: 0%"></div>
        </div>
        <p id="progressText">0% uploaded</p>
    </div>
    
    <div id="result" style="display: none;">
        <h3>Upload Complete!</h3>
        <p id="uploadTime"></p>
        <video id="videoPlayer" controls style="max-width: 100%; height: auto;"></video>
    </div>

    <script>
        let selectedFile = null;
        let startTime = null;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            if (selectedFile && selectedFile.type.startsWith('video/')) {
                document.getElementById('fileName').textContent = 'Name: ' + selectedFile.name;
                document.getElementById('fileSize').textContent = 'Size: ' + formatFileSize(selectedFile.size);
                document.getElementById('fileType').textContent = 'Type: ' + selectedFile.type;
                document.getElementById('fileInfo').style.display = 'block';
            } else {
                alert('Please select a valid video file');
            }
        });

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function uploadFile() {
            if (!selectedFile) return;
            
            startTime = Date.now();
            document.getElementById('progressContainer').style.display = 'block';
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            const xhr = new XMLHttpRequest();
            
            // Track upload progress
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    document.getElementById('progressBar').style.width = percentComplete + '%';
                    document.getElementById('progressText').textContent = Math.round(percentComplete) + '% uploaded';
                }
            });
            
            xhr.addEventListener('load', function() {
                const uploadTime = ((Date.now() - startTime) / 1000).toFixed(2);
                
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    document.getElementById('uploadTime').textContent = 'Upload completed in ' + uploadTime + ' seconds';
                    document.getElementById('videoPlayer').src = '/api/files/' + response.id + '/preview';
                    document.getElementById('result').style.display = 'block';
                    
                    console.log('Upload Performance Test Results:');
                    console.log('File size:', formatFileSize(selectedFile.size));
                    console.log('Upload time:', uploadTime + 's');
                    console.log('Average speed:', (selectedFile.size / (uploadTime * 1024 * 1024)).toFixed(2) + ' MB/s');
                } else {
                    alert('Upload failed: ' + xhr.responseText);
                }
            });
            
            xhr.addEventListener('error', function() {
                alert('Upload failed due to network error');
            });
            
            xhr.open('POST', '/api/files');
            xhr.withCredentials = true;
            xhr.send(formData);
        }
    </script>
</body>
</html>